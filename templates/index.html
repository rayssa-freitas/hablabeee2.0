<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Busca de Locais Próximos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
       body { background: #f5f8fa; }
    header { background: #4a90e2; color: white; padding: 1rem 0; margin-bottom: 2rem; }
    .card { border-radius: .75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    table thead { background: #e9ecef; }
    td { vertical-align: top; }
    .nowrap-btn { white-space: nowrap; min-width: 113px;}
  </style>
</head>
<body>
  <header class="text-center">
    <h1 class="fw-light">Busca de Locais Próximos</h1>
  </header>

  <main class="container-xxl" style="max-width: 1500px;">
    <div class="card p-4 mb-4">
      <form id="searchForm" class="row g-3">
        <div class="col-md-5">
          <label for="zoneSelect" class="form-label">Zona de Interesse</label>
          <select id="zoneSelect" class="form-select" required>
            <option value="">Selecione a Zona de Interesse</option>
            <!-- Preencha com suas zonas de intereste -->
            <option value="school">Escola</option>
            <option value="hospital">Hospital</option>
            <option value="movie_theater">Cinema</option>
            <option value="theater">Teatro</option>
            <option value="airport">Aeroporto</option>
            <option value="bus_station">Rodoviária</option>
            <option value="convention_center">Centro de Convenções</option>
            <option value="museum">Museu</option>
            <option value="hotel">Hotel</option>
            <option value="guesthouse">Pousada</option>
            <option value="shopping_center">Shopping</option>
            <option value="business">Comércio</option>
            <option value="retail">Varejo</option>
            <option value="shop">Loja</option>
            <option value="restaurant">Restaurante</option>
            <option value="university">Universidade</option>
            <option value="health_center">Posto de Saúde</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="latInput" class="form-label">Latitude</label>
          <input id="latInput" type="text" class="form-control" placeholder="-23.55052" required>
        </div>
        <div class="col-md-3">
          <label for="lngInput" class="form-label">Longitude</label>
          <input id="lngInput" type="text" class="form-control" placeholder="-46.63331" required>
        </div>

        <div class="col-md-1 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100 nowrap-btn">Pesquisar</button>
        </div>
      </form>
    </div>

    <div id="resultsSection" class="card p-4" style="display:none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Resultados</h5>
        <a id="downloadLink" href="#" class="btn btn-outline-secondary btn-sm" style="display:none;">Baixar CSV</a>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Cidade/UF</th>
              <th>Endereço</th>
              <th>Status</th>
              <th>Aberto agora?</th>
              <th>Horários</th>
              <th>Tipos</th>
              <th>Lat</th>
              <th>Lng</th>
              <th>Viewport</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Bootstrap 5 JS (opcional) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
/* PATCH 1 — Função robusta para horários (aceita PT já formatado ou EN “cru”) */
function formatarHorariosSemana(weekdayTextList) {
  if (!Array.isArray(weekdayTextList) || weekdayTextList.length === 0) {
    return 'Não disponível';
  }

  const clean = (s) => (s || '')
    .normalize('NFKD')
    .replace(/[\u2009\u200B-\u200D\u202F\u2060\uFEFF]/g, '')
    .trim();

  const cleaned = weekdayTextList.map(clean);

  // Se já veio em PT-BR, só exibe
  const rePtDay = /^(Segunda-feira|Terça-feira|Quarta-feira|Quinta-feira|Sexta-feira|Sábado|Domingo):\s/i;
  if (cleaned.some(l => rePtDay.test(l))) {
    return cleaned
      .map(l => l.replace(/\s?[–-]\s?/g, ' – '))
      .join('<br>');
  }

  // Converter EN -> PT + 12h -> 24h
  const mapaENtoPT = {
    Monday: 'Segunda-feira',
    Tuesday: 'Terça-feira',
    Wednesday: 'Quarta-feira',
    Thursday: 'Quinta-feira',
    Friday: 'Sexta-feira',
    Saturday: 'Sábado',
    Sunday: 'Domingo'
  };
  const ordem = ['Segunda-feira','Terça-feira','Quarta-feira','Quinta-feira','Sexta-feira','Sábado','Domingo'];
  const horarios = {};

  cleaned.forEach(linha => {
    const parts = linha.split(/:\s(.+)/);
    if (parts.length < 2) return;
    const diaEN = (parts[0] || '').trim();
    const horasRaw = (parts[1] || '').trim();
    const diaPT = mapaENtoPT[diaEN] || diaEN;

    if (!horasRaw || /closed/i.test(horasRaw)) {
      horarios[diaPT] = 'Fechado';
    } else if (/open 24 hours/i.test(horasRaw)) {
      horarios[diaPT] = 'Aberto 24 horas';
    } else {
      const intervalos = horasRaw.split(',').map(intervalo =>
        intervalo
          .replace(/(\d{1,2}):(\d{2})\s?(AM|PM)/gi, (_, h, min, ampm) => {
            let hh = parseInt(h, 10);
            if (ampm.toUpperCase() === 'PM' && hh !== 12) hh += 12;
            if (ampm.toUpperCase() === 'AM' && hh === 12) hh = 0;
            return `${hh.toString().padStart(2,'0')}:${min}`;
          })
          .replace(/\s?[–-]\s?/g, ' – ')
          .trim()
      );
      horarios[diaPT] = intervalos.join(' / ');
    }
  });

  return ordem
    .map(d => `${d}: ${Object.prototype.hasOwnProperty.call(horarios, d) ? horarios[d] : 'Não disponível'}`)
    .join('<br>');
}

/* PATCH 2 — Submit: desabilita botão, busca, preenche tabela, atualiza download, mostra seção, limpa inputs */
document.getElementById('searchForm').addEventListener('submit', async e => {
  e.preventDefault();

  const form = e.currentTarget;
  const btn = form.querySelector('button[type="submit"]');
  const type = document.getElementById('zoneSelect').value;
  const lat  = document.getElementById('latInput').value;
  const lng  = document.getElementById('lngInput').value;

  const originalLabel = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Pesquisando...';

  try {
    const resp = await fetch(`/search?type=${encodeURIComponent(type)}&lat=${encodeURIComponent(lat)}&lng=${encodeURIComponent(lng)}`);

    const ct = (resp.headers.get('content-type') || '').toLowerCase();
    let data;
    if (ct.includes('application/json')) {
      data = await resp.json();
    } else {
      const text = await resp.text();
      throw new Error(`HTTP ${resp.status} ${resp.statusText} — resposta não-JSON: ${text.slice(0,200)}`);
    }

    if (!resp.ok || !data.results) {
      throw new Error(data.error || 'Erro desconhecido');
    }

    const tbody = document.getElementById('resultsBody');
    tbody.innerHTML = '';

    data.results.forEach(p => {
      const horariosFormatados = formatarHorariosSemana(p.weekday_text);
      const tipos = Array.isArray(p.types)
      ? p.types
      : (typeof p.types === 'string'
          ? p.types.split(',').map(s => s.trim()).filter(Boolean)
          : []);
      const typesChips = tipos.length
        ? tipos.map(t => `<span class="badge bg-secondary me-1">${t}</span>`).join('')
        : '-';
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${p.name}</td>
        <td>${p.city_state}</td>
        <td>${p.address}</td>
        <td>${p.business_status}</td>
        <td>${p.open_now ? 'Sim' : 'Não'}</td>
        <td>${horariosFormatados}</td>
        <td>${typesChips}</td>
        <td>${p.latitude}</td>
        <td>${p.longitude}</td>
        <td>
          NE: (${p.viewport?.northeast?.lat?.toFixed?.(5)}, ${p.viewport?.northeast?.lng?.toFixed?.(5)})<br>
          SW: (${p.viewport?.southwest?.lat?.toFixed?.(5)}, ${p.viewport?.southwest?.lng?.toFixed?.(5)})
        </td>
      `;
      tbody.appendChild(row);
    });

    // Atualiza link de download e mostra resultados
    const dl = document.getElementById('downloadLink');
    dl.href = data.download_url;
    dl.download = '';
    dl.style.display = 'inline-block';

    document.getElementById('resultsSection').style.display = 'block';
    window.scrollTo({ top: document.getElementById('resultsSection').offsetTop, behavior: 'smooth' });

    // Limpa inputs após a busca
    form.reset();
  } catch (err) {
    console.error('Falha na busca:', err);
    alert('Erro na busca: ' + (err?.message || err));
  } finally {
    btn.disabled = false;
    btn.textContent = originalLabel;
  }
});
  </script>
</body>
</html>